---
title: "ascotraceR workflow"
author: "Dr. Paul Melloy"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup}
library(ascotraceR)
library(stationaRy) # for weather data
library(data.table)
library(ggplot2)
library(nasapower)
```


Download weather for turret

Potential trial to mimic SARDI fungicide trial in 2018.
[Description of the trial at GRDC publications](https://grdc.com.au/resources-and-publications/grdc-update-papers/tab-content/grdc-update-papers/2019/02/ascochyta-blight-in-intensive-cropping-of-pulses)

Lets see if we can download the weather data for this area
```{r}
met_stat <- as.data.table(get_station_metadata())

turret_deets <- met_stat[name == "TURRETFIELD RESEARCH CENTRE"]
turret_dat <- 
  get_met_data(station_id = turret_deets$id,
               years = 2018,
               full_data = TRUE)

setDT(turret_dat)
setnames(turret_dat,old = "aa1_2",
         new = "rain")

test_dat <-
  get_met_data(met_stat[lon < turret_deets$lon + 0.18 &
           lon > turret_deets$lon - 0.18 &
           lat < turret_deets$lat + 0.18 &
           lat > turret_deets$lat - 0.18][4,id],
           years = 2018,
           full_data = TRUE
)

test_dat2
```
Turretfield research station does not return data for 2018, we will try the next nearest stations

```{r}
met_stat[lat < -34.4 &
            lat > -34.8 &
            lon > 138.6 & 
            lon < 139]
test_dat
weather_dat
```

```{r}
setDT(test_dat)
test_dat[, rain := fcase(is.na(aa1_2), NA_real_,
                         aa1_2 == 999.9, 0, 
                         aa1_2 < 999.9, aa1_2)]
test_dat[ , c("lon", "lat", "wd_sd"):=
            .(139.000,-34.483,10)]


f_dat <- 
  format_weather(test_dat,
               POSIXct_time = "time",
               time_zone = "UTC",
               temp = "temp",
               rain = "rain",
               ws = "ws",
               wd = "wd",
               wd_sd = "wd_sd",
               station = "id",
               lon = "lon",
               lat = "lat")

library(GSODR)
tm_stat <- 
  GSODR::get_GSOD(years = c(2017,2018,2019),
                  station = "946810-99999")

Tm24 <- 
  lapply(seq_along(tm_stat$STNID),
      function(x){
        out <- impute_temperature(
          start_h = 0, 
          end_h = 23,
          max_Tm = as.numeric(tm_stat[x,"MAX"]),
          min_Tm = as.numeric(tm_stat[x,"MIN"]))
        #cat(out)
        return(out)
      } 
  )

Tm24 <- unlist(Tm24)
plot(Tm24[100:300],type = "l")

f_dat <-
  format_weather(
    tm_stat,
    YYYY = "YEAR",
    MM = "MONTH",
    DD = "DAY",
    time_zone = "UTC",
    temp = "TEMP",
    rain = "PRCP",
    ws = "WDSP",
    wd = "",
    wd_sd = "wd_sd",
    station = "id",
    lon = "lon",
    lat = "lat"
  )
```

```{r}
td_agg <-
  test_dat[ , .(wd = circular::mean.circular(wd,na.rm = TRUE,control.circular = "degrees"),
                ws = mean(ws, na.rm = TRUE)),
            by = data.table::mday(test_dat$time)
            ]
```



```{r get_power}
np_w <- get_power(community = "ag",
                  lonlat = c(138.832,-34.553),
                  pars = c("T2M","PRECTOTCORR","WD2M","WS2M"),
                  temporal_api = "hourly",
                  dates = c("2014-01-01","2014-12-30"),
                  time_standard = "UTC")
setDT(np_w)

```


```{r}
# Add station id
np_w[,id := "Turretfield"]

# set standard deviation of wd
np_w[,wdir_sd := 30]

f_dat <-
  format_weather(
    np_w,
    YYYY = "YEAR",
    MM = "MO",
    DD = "DY",
    hh = "HR",
    time_zone = "UTC",
    temp = "T2M",
    rain = "PRECTOTCORR",
    ws = "WS2M",
    wd = "WD2M",
    wd_sd = "wdir_sd",
    station = "id",
    lon = "LON",
    lat = "LAT"
  )
f_dat[,.(temp = mean(temp),
         rain = sum(rain)),
      by = .(YYYY,MM,DD)][MM >= 6 & MM <= 10,]
```

```{r}
T1 <- Sys.time()
ta1 <- trace_asco(weather = f_dat,
                  paddock_length = 10,
                  paddock_width = 20,
                  sowing_date = "2014-06-06",
                  harvest_date = "2014-09-17", # Guesstimated 
                  initial_infection = "2014-06-26",# estimated "Early in the season" 20 days after sowing
                  seeding_rate = 50, # Desi
                  primary_infection_foci = expand.grid(x = 1:20,
                                                       y = 1:10,
                                                       load = 5),
                  spores_per_gp_per_wet_hour = 0.22) # kyabra = 0.6
T2 <- Sys.time()
T2 - T1

s_ta1 <- summarise_trace(ta1)
td_ta1 <- tidy_trace(ta1)
```


```{r}
ggplot(data = subset(tidy_trace(ta1), i_day == 105),
       aes(x = x, y = y, fill = infectious_gp/susceptible_gp)) +
       geom_tile()



plot(y = s_ta1$infectious_gp/s_ta1$susceptible_gp,
     x = s_ta1$i_date,
     type = "l")
```

How does increasing the amount of starting inoculum change the results?

```{r}
T1 <- Sys.time()
ta2 <- trace_asco(weather = f_dat,
                  paddock_length = 10,
                  paddock_width = 20,
                  sowing_date = "2014-06-06",
                  harvest_date = "2014-09-17", # Guesstimated 
                  initial_infection = "2014-06-26",# estimated "Early in the season" 20 days after sowing
                  seeding_rate = 50, # Desi
                  primary_infection_foci = expand.grid(x = 1:20,
                                                       y = 1:10,
                                                       load = 10),
                  spores_per_gp_per_wet_hour = 0.22) # kyabra = 0.6
T2 <- Sys.time()
T2 - T1

s_ta2 <- summarise_trace(ta2)
td_ta2 <- tidy_trace(ta2)
```


```{r}
ggplot(data = subset(td_ta2, i_day == 105),
       aes(x = x, y = y, fill = infectious_gp/susceptible_gp)) +
       geom_tile()



plot(y = s_ta2$infectious_gp/s_ta2$susceptible_gp,
     x = s_ta2$i_date,
     type = "l")
```

How does changing the susceptibility change the results?

```{r}
T1 <- Sys.time()
ta3 <- trace_asco(weather = f_dat,
                  paddock_length = 10,
                  paddock_width = 20,
                  sowing_date = "2014-06-06",
                  harvest_date = "2014-09-17", # Guesstimated 
                  initial_infection = "2014-06-26",# estimated "Early in the season" 20 days after sowing
                  seeding_rate = 50, # Desi
                  primary_infection_foci = expand.grid(x = 1:20,
                                                       y = 1:10,
                                                       load = 5),
                  spores_per_gp_per_wet_hour = 0.6) # kyabra = 0.6
T2 <- Sys.time()
T2 - T1

s_ta3 <- summarise_trace(ta3)
td_ta3 <- tidy_trace(ta3)
```


```{r}
ggplot(data = subset(td_ta3, i_day == 105),
       aes(x = x, y = y, fill = infectious_gp/susceptible_gp)) +
       geom_tile()



plot(y = s_ta3$infectious_gp/s_ta3$susceptible_gp,
     x = s_ta3$i_date,
     type = "l")
lines(y = s_ta2$infectious_gp/s_ta2$susceptible_gp,
     x = s_ta2$i_date,
     type = "l", col = "red")
```

What if we run this till christmas. Does the crop stop growing?

```{r}
T1 <- Sys.time()
ta4 <- trace_asco(weather = f_dat,
                  paddock_length = 10,
                  paddock_width = 20,
                  sowing_date = "2014-06-06",
                  harvest_date = "2014-12-30", # Guesstimated 
                  initial_infection = "2014-06-26",# estimated "Early in the season" 20 days after sowing
                  seeding_rate = 50, # Desi
                  primary_infection_foci = expand.grid(x = 1:20,
                                                       y = 1:10,
                                                       load = 5),
                  spores_per_gp_per_wet_hour = 0.2) # kyabra = 0.6
T2 <- Sys.time()
T2 - T1

s_ta4 <- summarise_trace(ta4)
td_ta4 <- tidy_trace(ta4)
```


```{r}
ggplot(data = subset(td_ta4, i_day == 105),
       aes(x = x, y = y, fill = infectious_gp/susceptible_gp)) +
       geom_tile()



plot(y = s_ta4$infectious_gp/s_ta4$susceptible_gp,
     x = s_ta4$i_date,
     type = "l")

```


Test adding fungicide dates?

```{r}
T1 <- Sys.time()
ta5 <- trace_asco(weather = f_dat,
                  paddock_length = 10,
                  paddock_width = 20,
                  sowing_date = "2014-06-06",
                  harvest_date = "2014-10-30", # Guesstimated 
                  initial_infection = "2014-06-26",# estimated "Early in the season" 20 days after sowing
                  seeding_rate = 50, # Desi
                  primary_infection_foci = expand.grid(x = 1:20,
                                                       y = 1:10,
                                                       load = 5),
                  spores_per_gp_per_wet_hour = 0.6, # kyabra = 0.6
                  fungicide_dates = c("2014-07-07","2014-08-29","2014-09-07")) 
T2 <- Sys.time()
T2 - T1

s_ta5 <- summarise_trace(ta5)
td_ta5 <- tidy_trace(ta5)
```


```{r}
ggplot(data = subset(td_ta5, i_day == 105),
       aes(x = x, y = y, fill = infectious_gp/susceptible_gp)) +
       geom_tile()



plot(y = s_ta5$infectious_gp/s_ta5$susceptible_gp,
     x = s_ta5$i_date,
     type = "l")
lines(y = s_ta3$infectious_gp/s_ta3$susceptible_gp,
     x = s_ta3$i_date,
     type = "l", col = "red")

```
